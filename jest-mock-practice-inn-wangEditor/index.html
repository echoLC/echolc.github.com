<!DOCTYPE html><html lang="zh_cn"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.a6c7f84647b11eabade1.css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}h4{margin-top:16px}</style><meta name="generator" content="Gatsby 2.24.66"/><style data-styled="" data-styled-version="5.2.0">.bkQJbW{top:0;left:0;margin:0 auto;display:block;width:100%;z-index:1000;background-color:rgba(32,35,42,0.85);font-weight:700;}/*!sc*/
@media (min-width:700px){.bkQJbW{position:fixed;}}/*!sc*/
data-styled.g1[id="Header__HeaderWrapper-sc-1tnh9eg-0"]{content:"bkQJbW,"}/*!sc*/
.fWihwx{font-weight:700;margin-left:auto;margin-right:auto;height:60px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;max-width:770px;z-index:1000;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;overflow-x:auto;overflow-y:hidden;white-space:nowrap;padding:0px 20px;}/*!sc*/
data-styled.g2[id="Header__HeaderNav-sc-1tnh9eg-1"]{content:"fWihwx,"}/*!sc*/
.fMLOfn{display:none;-webkit-box-align:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
@media (min-width:700px){.fMLOfn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}/*!sc*/
data-styled.g3[id="Header__HeaderLinksContainer-sc-1tnh9eg-2"]{content:"fMLOfn,"}/*!sc*/
.dQgLDW{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#ffffff;border:0;margin:0;padding:8px 10px;min-width:42px;z-index:10;}/*!sc*/
.Header__HeaderLink-sc-1tnh9eg-3 + .Header__HeaderLink-sc-1tnh9eg-3{margin-left:0.7rem;}/*!sc*/
data-styled.g4[id="Header__HeaderLink-sc-1tnh9eg-3"]{content:"dQgLDW,"}/*!sc*/
.jUtDhN{padding-left:0;}/*!sc*/
data-styled.g5[id="Header__HeaderLinkTitle-sc-1tnh9eg-4"]{content:"jUtDhN,"}/*!sc*/
.cELrjN{display:block;padding-left:0;}/*!sc*/
data-styled.g6[id="Header__HeaderLinkTitleContent-sc-1tnh9eg-5"]{content:"cELrjN,"}/*!sc*/
.fikuAE{padding:4px;height:57px;}/*!sc*/
data-styled.g7[id="Header__HeaderImage-sc-1tnh9eg-6"]{content:"fikuAE,"}/*!sc*/
.fkabXU{z-index:30;top:0px;position:relative;color:#ffffff;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;background:transparent;border:none;cursor:pointer;padding:8px 12px;outline:none;-webkit-tap-highlight-color:transparent;}/*!sc*/
@media (min-width:700px){.fkabXU{display:none;}}/*!sc*/
data-styled.g10[id="Header__BurgerButton-sc-1tnh9eg-9"]{content:"fkabXU,"}/*!sc*/
.bEoVDl{width:24px;top:30px;height:2px;background:#ffffff;position:absolute;left:0;background:#ffffff;-webkit-transition:all 250ms cubic-bezier(0.86,0,0.07,1);transition:all 250ms cubic-bezier(0.86,0,0.07,1);}/*!sc*/
.bEoVDl::before{content:'';top:-8px;width:24px;height:2px;background:#ffffff;position:absolute;left:0;-webkit-transform:rotate(0);-ms-transform:rotate(0);transform:rotate(0);-webkit-transition:all 250ms cubic-bezier(0.86,0,0.07,1);transition:all 250ms cubic-bezier(0.86,0,0.07,1);}/*!sc*/
.bEoVDl::after{top:8px;content:'';width:24px;height:2px;background:white;position:absolute;left:0;-webkit-transform:rotate(0);-ms-transform:rotate(0);transform:rotate(0);-webkit-transition:all 250ms cubic-bezier(0.86,0,0.07,1);transition:all 250ms cubic-bezier(0.86,0,0.07,1);}/*!sc*/
data-styled.g11[id="Header__BurgerContent-sc-1tnh9eg-10"]{content:"bEoVDl,"}/*!sc*/
.cWabTu{text-align:left;padding-top:30px;padding-bottom:50px;background-color:#3E4047;color:#ffffff;padding-left:20px;padding-right:20px;margin:0 auto;}/*!sc*/
.cWabTu nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:row wrap;-ms-flex-flow:row wrap;flex-flow:row wrap;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;max-width:900px;margin:0 auto;}/*!sc*/
.cWabTu nav .footer-col{-webkit-flex:1 auto;-ms-flex:1 auto;flex:1 auto;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding-right:1em;}/*!sc*/
.cWabTu a{color:#ffffff;font-weight:bold;}/*!sc*/
.cWabTu a:hover{color:#CFCFD1;}/*!sc*/
.cWabTu .footer-col > p{margin:0;}/*!sc*/
.cWabTu .footer-title{font-size:0.83em;margin:0 0 1rem;}/*!sc*/
.cWabTu .footer-item{color:#ffffff;}/*!sc*/
.cWabTu .footer-item a{padding:0.25rem 0;display:block;}/*!sc*/
.cWabTu .footer-heart{color:red;}/*!sc*/
.cWabTu .footer-item-text{padding:0.1rem 0;color:#ffffff;}/*!sc*/
.cWabTu .footer-header{-webkit-order:1;-ms-flex-order:1;order:1;margin:0 0.25rem;margin-right:0.25rem;padding:0.25rem;}/*!sc*/
.cWabTu .footer-column-items{grid-template-columns:1fr;display:grid;}/*!sc*/
@media (max-width:564px){.cWabTu .footer-col:first-child{width:100%;}}/*!sc*/
data-styled.g12[id="Footer__FooterWrapper-havaaf-0"]{content:"cWabTu,"}/*!sc*/
*{box-sizing:border-box;margin:0;padding:0;}/*!sc*/
body{font-family:"Lato",sans-serif;color:#3E4047;background-color:#f4f8fb;}/*!sc*/
img{max-width:100%;height:auto;vertical-align:middle;border:0;}/*!sc*/
a{-webkit-text-decoration:none;text-decoration:none;color:#3E4047;}/*!sc*/
hr{border:0;border-top:1px solid #ECECED;margin:50px 0 5px 0;}/*!sc*/
ul,ol{padding-left:2em;margin:1em 0 0 0;}/*!sc*/
*::selection{background-color:#ffdc4e;}/*!sc*/
data-styled.g13[id="sc-global-aBoXv1"]{content:"sc-global-aBoXv1,"}/*!sc*/
.hXfboN{line-height:1.6;margin:1em 0 0 0;}/*!sc*/
data-styled.g15[id="Commons__Text-sc-1olsuhn-1"]{content:"hXfboN,"}/*!sc*/
.hwmpTs{display:inline-block;color:#697980;margin:0 4px;}/*!sc*/
.hwmpTs::before{content:'•';}/*!sc*/
data-styled.g16[id="Commons__Bull-sc-1olsuhn-2"]{content:"hwmpTs,"}/*!sc*/
.bVQAuV{margin:0 0;}/*!sc*/
@media (min-width:700px){.bVQAuV{margin:60px 0;}}/*!sc*/
data-styled.g17[id="layout__SiteContent-sc-1778ng8-0"]{content:"bVQAuV,"}/*!sc*/
.YtuhG{position:relative;border-radius:5px;width:80%;max-width:770px;word-wrap:break-word;background-color:#ffffff;margin:0px auto 30px auto;top:30px;padding:50px;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);}/*!sc*/
@media (max-width:780px){.YtuhG{width:100%;padding:25px;}}/*!sc*/
data-styled.g18[id="Wrapper-tgubax-0"]{content:"YtuhG,"}/*!sc*/
.hTrrVD{position:relative;display:table;width:100%;height:400px;overflow:hidden;background-repeat:no-repeat;background-position:center;background-size:cover;}/*!sc*/
data-styled.g23[id="Hero__HeroContainer-sc-11ssqgw-0"]{content:"hTrrVD,"}/*!sc*/
.eVIrsq{display:table-cell;vertical-align:middle;text-align:center;width:100%;}/*!sc*/
data-styled.g24[id="Hero__TitleContainer-sc-11ssqgw-1"]{content:"eVIrsq,"}/*!sc*/
.iyxybi{font-weight:700;font-size:3rem;margin:10px 50px;color:#ffffff;text-shadow:1px 1px 4px rgba(34,34,34,0.85);}/*!sc*/
data-styled.g25[id="Hero__HeroTitle-sc-11ssqgw-2"]{content:"iyxybi,"}/*!sc*/
.jjFmyv{display:inline;color:#697980;}/*!sc*/
data-styled.g27[id="TagList__ListContainer-sc-1uer3n1-0"]{content:"jjFmyv,"}/*!sc*/
.jwELq{text-transform:uppercase;color:#697980;}/*!sc*/
.jwELq:not(:first-child){margin-left:0.3rem;}/*!sc*/
.jwELq:hover{border-bottom:1px dotted #57595d;}/*!sc*/
.jwELq:before{content:'#';}/*!sc*/
data-styled.g28[id="TagList__TagListItemLink-sc-1uer3n1-1"]{content:"jwELq,"}/*!sc*/
.itnVfJ{text-transform:uppercase;color:#697980;}/*!sc*/
.itnVfJ:not(:first-child){margin-left:0.3rem;}/*!sc*/
.itnVfJ:before{content:'#';}/*!sc*/
data-styled.g29[id="TagList__TagListItem-sc-1uer3n1-2"]{content:"itnVfJ,"}/*!sc*/
.dzXCsB .author-image{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;position:absolute;top:-40px;left:50%;margin-left:-40px;width:80px;height:80px;border-radius:100%;overflow:hidden;padding:6px;z-index:2;box-shadow:#ececec 0 0 0 1px;background-color:#ffffff;}/*!sc*/
.dzXCsB .author-image .img{position:relative;display:block;width:100%;height:100%;background-size:cover;background-position:center center;border-radius:100%;}/*!sc*/
.dzXCsB .author-profile .author-image{position:relative;left:auto;top:auto;width:120px;height:120px;padding:3px;margin:-100px auto 0 auto;box-shadow:none;}/*!sc*/
data-styled.g42[id="Bio__BioWrapper-jo9hw1-0"]{content:"dzXCsB,"}/*!sc*/
.bvupla a{box-shadow:0 2px 0 0 #ffdc4e;}/*!sc*/
.bvupla a:hover{-webkit-filter:brightness(150%);filter:brightness(150%);box-shadow:none;}/*!sc*/
data-styled.g43[id="Bio__BioText-jo9hw1-1"]{content:"bvupla,"}/*!sc*/
.BRZWt{margin-bottom:2rem;color:#57595d;font-size:0.9em;}/*!sc*/
data-styled.g47[id="ContentHeader__Header-zp5a3e-0"]{content:"BRZWt,"}/*!sc*/
.elokSk{line-height:1.6;}/*!sc*/
.elokSk > h2{padding-top:3rem;margin-top:3rem;border-top:1px solid #ececec;}/*!sc*/
.elokSk > h3{padding-top:3rem;}/*!sc*/
.elokSk > p{margin:1em 0 0 0;}/*!sc*/
.elokSk a{box-shadow:0 2px 0 0 #ffdc4e;}/*!sc*/
.elokSk a:hover{-webkit-filter:brightness(150%);filter:brightness(150%);box-shadow:none;}/*!sc*/
.elokSk a.anchor,.elokSk a.gatsby-resp-image-link{box-shadow:none;}/*!sc*/
.elokSk h1 .anchor svg,.elokSk h2 .anchor svg,.elokSk h3 .anchor svg,.elokSk h4 .anchor svg,.elokSk h5 .anchor svg,.elokSk h6 .anchor svg{visibility:hidden;margin-left:-16px;}/*!sc*/
.elokSk h1:hover .anchor svg,.elokSk h2:hover .anchor svg,.elokSk h3:hover .anchor svg,.elokSk h4:hover .anchor svg,.elokSk h5:hover .anchor svg,.elokSk h6:hover .anchor svg,.elokSk h1 .anchor:focus svg,.elokSk h2 .anchor:focus svg,.elokSk h3 .anchor:focus svg,.elokSk h4 .anchor:focus svg,.elokSk h5 .anchor:focus svg,.elokSk h6 .anchor:focus svg{visibility:visible;}/*!sc*/
.elokSk > blockquote{box-sizing:border-box;background-color:#f7f7f7;border-left:5px solid rgb(244,213,36);margin:30px 0px;padding:5px 20px;border-radius:0 8px 8px 0;}/*!sc*/
.elokSk > blockquote p{margin:0.8em 0;font-style:italic;}/*!sc*/
.elokSk .gatsby-highlight{border-radius:5px;font-size:15px;line-height:1.7;border-radius:10px;overflow:auto;tab-size:1.5em;margin:1.5em -1.5em;}/*!sc*/
@media (max-width:500px){.elokSk .gatsby-highlight{border-radius:0;margin-left:-25px;margin-right:-25px;}}/*!sc*/
.elokSk .gatsby-highlight > pre{border:0;margin:0;padding:1;}/*!sc*/
.elokSk .gatsby-highlight pre[class*='language-']{float:left;min-width:100%;}/*!sc*/
.elokSk .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;border-left:0.25em solid #ffdc4e;}/*!sc*/
.elokSk h1 > code.language-text,.elokSk h2 > code.language-text,.elokSk h3 > code.language-text,.elokSk h4 > code.language-text,.elokSk h5 > code.language-text,.elokSk h6 > code.language-text,.elokSk a > code.language-text,.elokSk p > code.language-text,.elokSk li > code.language-text,.elokSk em > code.language-text,.elokSk strong > code.language-text{background:#fff9d9;color:#222222cc;padding:0 3px;font-size:0.94em;border-radius:0.3rem;word-wrap:break-word;}/*!sc*/
.elokSk code{word-wrap:break-word;}/*!sc*/
.elokSk table{margin-top:1em;border-collapse:collapse;border-radius:0.5em;overflow:hidden;}/*!sc*/
.elokSk table th,.elokSk table td{padding:0.5em;background:#f7f7f7;border-bottom:2px solid #ffffff;}/*!sc*/
data-styled.g48[id="Content__ContentBody-sc-1kg87pw-0"]{content:"elokSk,"}/*!sc*/
.eguhaU{padding:0 30px 30px;}/*!sc*/
@media only screen and (max-width:500px){.eguhaU{padding:0;}}/*!sc*/
data-styled.g49[id="Article__ArticleWrapper-sc-1ux1py6-0"]{content:"eguhaU,"}/*!sc*/
.gtmBNT{position:relative;margin:6rem 0 0;padding:3rem 0 0;border-top:1px solid #ececec;}/*!sc*/
data-styled.g50[id="Article__ArticleFooter-sc-1ux1py6-1"]{content:"gtmBNT,"}/*!sc*/
.bPNZMx{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;max-width:770px;width:80%;margin:0px auto 30px auto;top:20px;position:relative;}/*!sc*/
@media (max-width:780px){.bPNZMx{width:100%;padding:25px;}}/*!sc*/
data-styled.g51[id="PrevNextPost__PreviewContainer-sc-123t7d4-0"]{content:"bPNZMx,"}/*!sc*/
.egyLTL{cursor:pointer;-webkit-flex:1 1 300px;-ms-flex:1 1 300px;flex:1 1 300px;background-color:#ffffff;box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,0.1);margin:20px 20px;border-radius:5px;}/*!sc*/
.egyLTL:hover{box-shadow:0 0 0 0,0 6px 12px #B2B3B5;-webkit-transition:all 0.3s ease;transition:all 0.3s ease;-webkit-transform:translate3D(0,-1px,0);-ms-transform:translate3D(0,-1px,0);transform:translate3D(0,-1px,0);}/*!sc*/
@media (min-width:780px){.egyLTL:first-child{margin-left:0;}.egyLTL:last-child{margin-right:0;}}/*!sc*/
data-styled.g52[id="PrevNextPost__Preview-sc-123t7d4-1"]{content:"egyLTL,"}/*!sc*/
.cyZgCh{width:auto;height:200px;background:#c5d2d9 no-repeat 50%;background-size:cover;border-radius:5px 5px 0 0;}/*!sc*/
data-styled.g53[id="PrevNextPost__PreviewCover-sc-123t7d4-2"]{content:"cyZgCh,"}/*!sc*/
.eZfqaY{padding:20px;}/*!sc*/
.eZfqaY header{padding:0 0 10px 0;}/*!sc*/
.eZfqaY section{padding-bottom:10px;}/*!sc*/
.eZfqaY footer{font-size:0.8em;}/*!sc*/
data-styled.g54[id="PrevNextPost__PreviewContent-sc-123t7d4-3"]{content:"eZfqaY,"}/*!sc*/
.liMOCK{color:#697980;}/*!sc*/
data-styled.g56[id="Time__TimeContainer-f76ycl-0"]{content:"liMOCK,"}/*!sc*/
.jcGTcy{text-transform:uppercase;color:#697980;}/*!sc*/
data-styled.g57[id="Commons__ReadingTimeContainer-sc-1olsuhn-3"]{content:"jcGTcy,"}/*!sc*/
</style><title data-react-helmet="true">Typescript中的条件类型 | echoLC</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Lato:400,700&amp;display=swap" rel="stylesheet"/><link data-react-helmet="true" rel="canonical" href="https://echolc.github.io/jest-mock-practice-inn-wangEditor"/><meta data-react-helmet="true" name="description" content="前言 wangEditor 是一个优秀的国产富文本编辑器，因为其  API  设计简单易用深受国内很多用户的喜爱，目前，我们有3个人数过千的用户QQ群， github star 数已经达到了 11k ，在  NPM  上的周下载量在 10k…"/><meta data-react-helmet="true" property="og:url" content="https://echolc.github.io/jest-mock-practice-inn-wangEditor"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Typescript中的条件类型 | echoLC"/><meta data-react-helmet="true" property="og:description" content="前言 wangEditor 是一个优秀的国产富文本编辑器，因为其  API  设计简单易用深受国内很多用户的喜爱，目前，我们有3个人数过千的用户QQ群， github star 数已经达到了 11k ，在  NPM  上的周下载量在 10k…"/><meta data-react-helmet="true" property="og:image" content="https://echolc.github.io/huoyingzhishui.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="echoLC"/><meta data-react-helmet="true" name="twitter:title" content="Typescript中的条件类型 | echoLC"/><meta data-react-helmet="true" name="twitter:description" content="前言 wangEditor 是一个优秀的国产富文本编辑器，因为其  API  设计简单易用深受国内很多用户的喜爱，目前，我们有3个人数过千的用户QQ群， github star 数已经达到了 11k ，在  NPM  上的周下载量在 10k…"/><meta data-react-helmet="true" name="twitter:image" content="https://echolc.github.io/huoyingzhishui.jpg"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=7b1a146906268ffe34d938dbc29af59d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#222222"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=7b1a146906268ffe34d938dbc29af59d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=7b1a146906268ffe34d938dbc29af59d"/><link as="script" rel="preload" href="/webpack-runtime-c61a43b1af9572f2b9fb.js"/><link as="script" rel="preload" href="/framework-445649399d1c721f1f74.js"/><link as="script" rel="preload" href="/app-35c7a169ecc7765edc62.js"/><link as="script" rel="preload" href="/styles-e9d24b1846c7d6eb9685.js"/><link as="script" rel="preload" href="/3a2f1ab89072400eb78a258db61265f1964eff8a-17ff65e584d80acaf7aa.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-7c929e5f88b2d26f9440.js"/><link as="fetch" rel="preload" href="/page-data/jest-mock-practice-inn-wangEditor/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1956263691.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2749999020.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><header class="Header__HeaderWrapper-sc-1tnh9eg-0 bkQJbW"><nav class="Header__HeaderNav-sc-1tnh9eg-1 fWihwx"><a aria-label="View home page" class="Header__HeaderLink-sc-1tnh9eg-3 Header__HeaderLinkTitle-sc-1tnh9eg-4 dQgLDW jUtDhN" href="/"><img src="/static/7b1a146906268ffe34d938dbc29af59d/1b595/baymax.png" alt="echoLC" class="Header__HeaderImage-sc-1tnh9eg-6 fikuAE"/><span class="Header__HeaderLinkTitleContent-sc-1tnh9eg-5 cELrjN">echoLC</span></a><div class="Header__HeaderLinksContainer-sc-1tnh9eg-2 fMLOfn"><a aria-label="View 博客 page" class="Header__HeaderLink-sc-1tnh9eg-3 dQgLDW" href="/">博客</a><a aria-label="View 关于 page" class="Header__HeaderLink-sc-1tnh9eg-3 dQgLDW" href="/about">关于</a></div><button aria-label="open menu" class="Header__BurgerButton-sc-1tnh9eg-9 fkabXU"><div class="Header__BurgerContent-sc-1tnh9eg-10 bEoVDl"></div></button></nav></header><div class="layout__SiteContent-sc-1778ng8-0 bVQAuV"><div style="background-image:url(&quot;/static/d8d5730a3ad5e3cfc74f32c146998e29/14b42/huoyingzhishui.jpg&quot;)" class="Hero__HeroContainer-sc-11ssqgw-0 hTrrVD"><div class="Hero__TitleContainer-sc-11ssqgw-1 eVIrsq"><h1 class="Hero__HeroTitle-sc-11ssqgw-2 iyxybi">Typescript中的条件类型</h1></div></div><main role="main" class="Wrapper-tgubax-0 YtuhG"><article class="Article__ArticleWrapper-sc-1ux1py6-0 eguhaU"><section><header class="ContentHeader__Header-zp5a3e-0 BRZWt"><time class="Time__TimeContainer-f76ycl-0 liMOCK">2021年2月2日</time><span class="Commons__Bull-sc-1olsuhn-2 hwmpTs"></span><div class="TagList__ListContainer-sc-1uer3n1-0 jjFmyv"><a class="TagList__TagListItemLink-sc-1uer3n1-1 jwELq" href="/tags/Jest">Jest</a>, <a class="TagList__TagListItemLink-sc-1uer3n1-1 jwELq" href="/tags/wangEditor">wangEditor</a></div></header><div class="Content__ContentBody-sc-1kg87pw-0 elokSk"><h2 id="前言" style="position:relative"><a href="#%E5%89%8D%E8%A8%80" aria-label="前言 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h2><p><a href="https://github.com/wangeditor-team/wangEditor">wangEditor</a>是一个优秀的国产富文本编辑器，因为其 <code class="language-text">API</code> 设计简单易用深受国内很多用户的喜爱，目前，我们有3个人数过千的用户QQ群，<code class="language-text">github star</code>数已经达到了<strong>11k</strong>，在 <code class="language-text">NPM</code> 上的周下载量在<strong>10k</strong>左右，在国产开源项目里面，特别是富文本编辑器领域内，已经算是很不错的成绩了。</p><p>2020我们升级了 <code class="language-text">V4</code> 版本，使用 <code class="language-text">Typescript</code> 重写，这次我们是以组建开源团队的形式，大家分工对编辑器各模块进行开发。我是在2020年10月份加入 <code class="language-text">wangEditor</code> 开发团队的，那时候核心功能基本已经开发完毕了。加入团队后，我主要负责项目的测试，包括单元测试（后面简称单测）和 <code class="language-text">E2E</code> 测试，通过提高单测的覆盖率和质量保证项目代码的质量。</p><p><code class="language-text">V4</code>升级以来，我们落下了很多单测，这一块说句实话我们做的不怎么好。我刚加入团队的时候，单测覆盖率最高在 <strong>65%</strong> 左右，后面一度出现下降的趋势，最低的时候到 <strong>62%</strong> 左右。说实话，作为一个优秀的开源项目，这个数字的单测覆盖率肯定是不及格的，但是话又说回来，富文本场景因为其 API 特殊性，还有就是依赖交互的功能，给单元测试的实施带来了巨大的挑战。</p><h2 id="富文本编辑器单元测试难在哪" style="position:relative"><a href="#%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%9A%BE%E5%9C%A8%E5%93%AA" aria-label="富文本编辑器单元测试难在哪 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>富文本编辑器单元测试难在哪</h2><p><strong>其一</strong>，稍微看过我们编辑器源码的小伙伴应该知道，我们的核心模块：<code class="language-text">Editor</code>、<code class="language-text">Text</code>、<code class="language-text">History</code>、<code class="language-text">Selection</code>、<code class="language-text">Menu</code> 等，它们的设计都是类的方式，而且作为 <code class="language-text">Editor</code> 的依赖，频繁跟编辑器进行交互来驱动编辑器的功能。我们知道，在单元测试中，最复杂的测试场景之一就是对象之间的交互。我们的整个设计就已经注定了我们的单测不会容易，当然这样的设计对于复用和模块之间的划分还是很有帮助的。</p><p><strong>其二</strong>，编辑器的经典产品呈现模式，就是工具栏和编辑区域两块。编辑区域使用 <code class="language-text">contenteditable</code> 使得容器有了编辑的能力，菜单和编辑区域通过用户操作来进行配合，进行加粗、对齐样式、标题样式、代码块、引用、插入图片等功能交互。这就使得，编辑器的很多功能测试要依赖用户的交互，比如点击、鼠标移出和移入、键盘、滚动、复制和粘贴等事件。</p><p><strong>其三</strong>，在 <code class="language-text">Jest</code> 中很多原生的浏览器 API 都是不支持的，例如我们编辑器核心的 API：<code class="language-text">document.execCommand</code>，还有 <code class="language-text">Clipboard Event</code>等。而其它的一些核心对象 <code class="language-text">Selection</code> 就算支持，也很难在 <code class="language-text">Jest</code> 中模拟用户的操作去进行选区操作，这都给单元测试带来了困难。</p><p>除此之外，还有上传图片功能涉及到 <code class="language-text">Ajax</code>、<code class="language-text">File</code> 等对象，我们知道单测是不能有真实依赖物的，你不能让图片上传这样的功能测试依赖真实的 API 服务。如果使用了真实依赖物，那么你做的就不是单元测试了，而是集成测试。</p><h2 id="wangeditor是怎么解决上述这些问题的" style="position:relative"><a href="#wangeditor%E6%98%AF%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%E4%B8%8A%E8%BF%B0%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98%E7%9A%84" aria-label="wangeditor是怎么解决上述这些问题的 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>wangEditor是怎么解决上述这些问题的</h2><p>我刚接受项目的单元测试的时候，我也一度比较愁，于是我重新撸了一遍 <code class="language-text">Jest</code> 的官网文档，买了学习单测的书籍，进行知识储备。无论是对象交互，还是依赖用户交互的功能，亦或是 <code class="language-text">Ajax</code> 测试，没有什么是伪对象（Fake Object）解决不了的，对于我们在测试中不能控制的对象，使用伪对象替换就行了。</p><p>这里先普及一点单元测试中比较重要的知识，<strong>伪对象技术（Fake Object）</strong>。 在单测中最常用的有两类伪对象，一类叫模拟对象（mock object），一类叫存根对象（stub object）。在做对象交互测试的时候，我们就需要经常使用这两种对象。那么它们之间有什么区别了？</p><p><strong>模拟对象</strong>是测试系统中的伪对象，它可以验证被测试对象是否按照我们预期的方式进行调用，从而对单元测试的结果产生影响，所以通常我们在测试中会对模拟对象进行断言。下面讲到具体的例子时，我会再具体介绍。</p><p><strong>存根对象</strong> 也是伪对象的一种，但是存根对象只是在测试中起着“站桩”的作用，协助我们测试，最后我们并不会对 <code class="language-text">stub</code> 对象进行断言。</p><p>下面的图，可以加深我们的理解：</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2815b3238f44603b3ec1fbb948d6b72~tplv-k3u1fbpfcp-watermark.image"/>
<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b12eb2604487442ab8df696333b87689~tplv-k3u1fbpfcp-watermark.image"/></p><p>在 <code class="language-text">wangEditor</code> 中，我们大量使用了这两种技术来协助单元测试。</p><h2 id="jest中的模拟技术" style="position:relative"><a href="#jest%E4%B8%AD%E7%9A%84%E6%A8%A1%E6%8B%9F%E6%8A%80%E6%9C%AF" aria-label="jest中的模拟技术 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Jest中的模拟技术</h2><p>我们使用的测试框架是 <code class="language-text">Jest</code> ，为了后续的介绍做铺垫，这里先稍微普及一点 <code class="language-text">Jest</code> 中的模拟技术。在 <code class="language-text">Jest</code> 中是没有区分模拟对象和存根对象的，也没有 API 来区分 <code class="language-text">mock</code> 或者 <code class="language-text">stub</code>，怎么区分两种对象还是看你怎么在测试中使用 <code class="language-text">Jest</code> API所创建的对象。 </p><h3 id="模拟函数" style="position:relative"><a href="#%E6%A8%A1%E6%8B%9F%E5%87%BD%E6%95%B0" aria-label="模拟函数 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟函数</h3><p>在 <code class="language-text">Jest</code> 中模拟函数非常简单，下面看几个例子：</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fn1 <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&#x27;fn1&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fn2 <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></div><p>上面这几种方式都是常见的模拟函数的方式。</p><h3 id="模拟es6-class" style="position:relative"><a href="#%E6%A8%A1%E6%8B%9Fes6-class" aria-label="模拟es6 class permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟ES6 class</h3><p>除了模拟函数外，<code class="language-text">Jest</code> 也可以模拟 <code class="language-text">ES6</code> 中的类：</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">&#x27;./sound-player&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SoundPlayerConsumer <span class="token keyword">from</span> <span class="token string">&#x27;./sound-player-consumer&#x27;</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#x27;./sound-player&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;We can check if the consumer called the class constructor&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>SoundPlayer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>当然你也可以模拟类具体的方法：</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">&#x27;./sound-player&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#x27;./sound-player&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> mockPlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>这是 <code class="language-text">Jest</code> 官网的几个例子，这里我就不具体介绍了，大家感兴趣可以去 <a href="https://jestjs.io/docs/en/es6-class-mocks">Jest</a> 官网了解更多 。</p><h3 id="模拟某个对象的某个方法" style="position:relative"><a href="#%E6%A8%A1%E6%8B%9F%E6%9F%90%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9F%90%E4%B8%AA%E6%96%B9%E6%B3%95" aria-label="模拟某个对象的某个方法 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟某个对象的某个方法</h3><p>在 <code class="language-text">Jest</code> 有一个很好用的 API：<a href="https://jestjs.io/docs/en/jest-object#jestspyonobject-methodname">jest.spyOn</a>，这是我在项目中经常用的，下面看我们项目中的一个例子：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> liParent <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#x27;&lt;ul&gt;&lt;/ul&gt;&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> li <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#x27;&lt;li&gt;&lt;/li&gt;&#x27;</span><span class="token punctuation">)</span>
liParent<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span>

jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">,</span> <span class="token string">&#x27;getSelectionContainerElem&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span></code></pre></div><h2 id="wangeditor中的模拟技术使用" style="position:relative"><a href="#wangeditor%E4%B8%AD%E7%9A%84%E6%A8%A1%E6%8B%9F%E6%8A%80%E6%9C%AF%E4%BD%BF%E7%94%A8" aria-label="wangeditor中的模拟技术使用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>wangEditor中的模拟技术使用</h2><p>前面介绍到在 <code class="language-text">wangEditor</code> 中有大量的测试场景都涉及到对象交互，所以创建各种模拟对象或者存根对象必不可少。下面，我们一个个介绍。</p><h3 id="模拟dcoumentexeccommand" style="position:relative"><a href="#%E6%A8%A1%E6%8B%9Fdcoumentexeccommand" aria-label="模拟dcoumentexeccommand permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟dcoument.execCommand</h3><p>前面我们提到，在 <code class="language-text">Jest</code> 中，并不支持原生的 <code class="language-text">document.execCommand API</code>，但是我们又有大量的测试场景需要依赖该 <code class="language-text">API</code>，所以我们模拟了该函数：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mockCommand</span> <span class="token punctuation">(</span>document<span class="token operator">:</span> Document<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>execCommand <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>queryCommandValue <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>queryCommandState <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>queryCommandSupported <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div><p>在测试中使用：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> mockCommand <span class="token keyword">from</span> <span class="token string">&#x27;../../helpers/command-mock&#x27;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;调用 createAction 能创建指定行和列的表格&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token function">mockCommand</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span>
    
    <span class="token keyword">const</span> editor <span class="token operator">=</span> <span class="token function">createEditor</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">div1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> createTableInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateTable</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span>
    createTableInstance<span class="token punctuation">.</span><span class="token function">createAction</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token function">expect</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>execCommand<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span>
    	<span class="token string">&#x27;insertHTML&#x27;</span><span class="token punctuation">,</span> 
     <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;table border=&quot;0&quot; width=&quot;100%&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;th&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;			&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><h3 id="模拟xhr" style="position:relative"><a href="#%E6%A8%A1%E6%8B%9Fxhr" aria-label="模拟xhr permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟XHR</h3><p>在测试图片上传模块的时候，我们需要依赖 <code class="language-text">Ajax</code>，但是我们没有使用真实的 <code class="language-text">API</code> 服务，所以我们只能通过模拟的方式，去手动调用<code class="language-text">Ajax</code> 的方法，我首先封装了一个 <code class="language-text">xhrMockClass</code>：</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token function-variable function">xhrMockClass</span> <span class="token operator">=</span> <span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    open<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    send<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    setRequestHeader<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ontimeout<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    upload<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    onreadystatechange<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    status<span class="token operator">:</span> config<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
    readyState<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    responseText<span class="token operator">:</span> config<span class="token punctuation">.</span>res<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> xhrMockClass</code></pre></div><p>通过一些参数，控制 <code class="language-text">Ajax</code> 的返回，从而模拟各种场景，以达到测试的目的，看在测试中的具体使用：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;调用 uploadImg 上传图片失败，支持配置 onError 钩子监听&#x27;</span><span class="token punctuation">,</span> done <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> errorFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> alertFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">createUploadImgInstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            uploadImgServer<span class="token punctuation">,</span>
            uploadImgHooks<span class="token operator">:</span> <span class="token punctuation">{</span>
                error<span class="token operator">:</span> errorFn<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            customAlert<span class="token operator">:</span> alertFn<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token function">createMockFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> mockXHRObject <span class="token operator">=</span> <span class="token function">mockXHRHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

        upload<span class="token punctuation">.</span><span class="token function">uploadImg</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>

        mockXHRObject<span class="token punctuation">.</span><span class="token function">onreadystatechange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">expect</span><span class="token punctuation">(</span>errorFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>有些小伙伴可能有疑问，在 <code class="language-text">setTimeout</code> 断言之前的 <code class="language-text">onreadystatechange</code> 调用，这不是人为去执行模拟的 <code class="language-text">Ajax</code> 方法吗？这样有什么意义。首先，你要明白的是在上面的测试的场景中，你更关心的是当 <code class="language-text">Ajax</code> 返回错误的时候，你定义的错误处理钩子有没有正确执行。你并不需要关心 <code class="language-text">Ajax</code> 是怎么发生的，管它是我们手动模拟让它发生的，还是真实的 <code class="language-text">API</code> 服务返回的，这并不影响我们的测试。</p><p>在该测试中，我们还模拟了两个函数，一个是我们关注的 <code class="language-text">onError</code> 钩子，一个是 <code class="language-text">alert</code>。因为错误发生时，我们的代码处理是既执行 <code class="language-text">onError</code> 钩子，还会 <code class="language-text">alert</code> 错误信息。而如果不传这个 <code class="language-text">alert</code>，默认调用的是原生的 <code class="language-text">window.alert</code>，在 <code class="language-text">Jest</code> 中也是不支持该 API 的，这样测试就会报错而失败。回顾刚开始介绍的模拟对象和存根对象的区别，在这里我们断言的是错误回调的钩子有没有被执行，所以<code class="language-text">alertFn</code> 在这里就是存根对象，而 <code class="language-text">errorFn</code> 才是我们测试关注的模拟对象。</p><h3 id="模拟用户交互" style="position:relative"><a href="#%E6%A8%A1%E6%8B%9F%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92" aria-label="模拟用户交互 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟用户交互</h3><p>前面我们介绍了，富文本还有一块比较难测的是依赖用户交互的场景很多。有些菜单的设计暴露了 <code class="language-text">clickHandler</code> 的公开 <code class="language-text">API</code>，所以你可以直接调用 <code class="language-text">clickHandler</code> 进行测试。但是有些场景，我们没法直接调用到 <code class="language-text">click</code> 回调，就没法测试到回调中的代码。对于 <code class="language-text">click</code> 交互，其实只要我们通过 <code class="language-text">dom</code> 操作找到对应的元素，然后调用其 <code class="language-text">click</code> 方法，就可以触发对应的回调了。然而，还有些场景，比如我们的下拉，是需要 <code class="language-text">mouseEnter</code> 事件触发的，对于这种场景，就算我们定位到元素，也没对应的方法可以触发该事件。</p><p>经过调研，发现 <code class="language-text">dom</code> 元素有一个原生的 <code class="language-text">dispatchEvent</code> 方法，可以主动触发大部分的鼠标、键盘事件。于是，我封装了 <code class="language-text">dispatchEvent</code> 方法，专门用来模拟用户的一些交互事件：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> DomElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;../../src/utils/dom-core&#x27;</span>

<span class="token keyword">const</span> EventType <span class="token operator">=</span> <span class="token punctuation">{</span>
    Event<span class="token operator">:</span> Event<span class="token punctuation">,</span>
    KeyBoardEvent<span class="token operator">:</span> KeyboardEvent<span class="token punctuation">,</span>
    MouseEvent<span class="token operator">:</span> MouseEvent<span class="token punctuation">,</span>
    <span class="token comment">// jest 没有ClipboardEvent，使用Event替代</span>
    ClipboardEvent<span class="token operator">:</span> Event<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">EventTypeKey</span> <span class="token operator">=</span> <span class="token keyword">keyof</span> <span class="token keyword">typeof</span> EventType

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mockEventTrigger</span><span class="token punctuation">(</span>
    $el<span class="token operator">:</span> DomElement<span class="token punctuation">,</span>
    <span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    eventType<span class="token operator">:</span> EventTypeKey <span class="token operator">=</span> <span class="token string">&#x27;Event&#x27;</span><span class="token punctuation">,</span>
    option<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> EventConstruct <span class="token operator">=</span> EventType<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span>

    <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventConstruct</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        view<span class="token operator">:</span> window<span class="token punctuation">,</span>
        bubbles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        cancelable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>option<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    $el<span class="token punctuation">.</span>elems<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div><p>在测试中应用 <code class="language-text">dispatchEvent</code>：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;编辑器初始化后，编辑器区域会绑定 enter键 keyup 事件，触发执行eventsHook enterUpEvents的函数执行&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mockClickFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>txt<span class="token punctuation">.</span>eventHooks<span class="token punctuation">,</span> <span class="token string">&#x27;enterUpEvents&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            value<span class="token operator">:</span> <span class="token punctuation">[</span>mockClickFn<span class="token punctuation">,</span> mockClickFn<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">,</span> <span class="token string">&#x27;keyup&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;KeyBoardEvent&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            keyCode<span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 模拟不是enter键的情况</span>
        <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">,</span> <span class="token string">&#x27;keyup&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;KeyBoardEvent&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            keyCode<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">expect</span><span class="token punctuation">(</span>mockClickFn<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>在上面的例子中，我们先劫持了事件钩子里的 <code class="language-text">enterUpEvents</code> 的值，使用 <code class="language-text">Jest</code> 模拟函数来替代。然后分别触发 <code class="language-text">enter</code> 键 <code class="language-text">KeyBoardEvent</code> 事件和其它非 <code class="language-text">Enter</code> 键的事件，最后断言模拟函数执行了两次，而不是四次。</p><p>使用封装的 <code class="language-text">dispatchEvent</code> 使得单测覆盖了几乎所有的鼠标和键盘事件场景，小伙伴们再也不用担心依赖用户交互的场景该怎么写单测。当然，目前还有一些事件没法模拟，不知道是否是我没有找到正确的方式，例如滚动事件，我试了很多方式，都没有能模拟成功。</p><h3 id="其它" style="position:relative"><a href="#%E5%85%B6%E5%AE%83" aria-label="其它 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它</h3><p>除了上述提到的，我们在测试中还模拟了一些其它的对象，比如模拟文件、模拟不同浏览器等，限于篇幅，在这里我就不一一介绍，感兴趣的小伙伴可以直接去我们仓库 <code class="language-text">test</code> 目录下详细查看：<a href="https://github.com/wangeditor-team/wangEditor/tree/master/test">wangEditor</a>。</p><p>在这里还要补充的是，我们项目中大量使用的两个 <code class="language-text">API</code> 去模拟对象中的方法或者对象的值，它们分别是 <code class="language-text">jest.spyOn</code> 和 <code class="language-text">Object.defineProperty</code>。对于 <code class="language-text">jest.spyOn</code>，我经常用来做一些存根对象（大多是对象方法）的模拟。刚开始我就提到了，<code class="language-text">wangEditor</code> 很多功能依赖选区，然后对选区进行操作，或者获取选区里面的元素进行操作。但是，我们很难在 <code class="language-text">Jest</code> 中去真正的依赖选区进行测试，所以这时候就需要使用存根对象进行替换。我们封装的 <code class="language-text">selection</code> 对象是对选区操作和读取的集合，而它做为 <code class="language-text">Editor</code>的一个依赖项，大多数情况下我们只需要去替换它的具体方法实现就可以让我们轻松进行测试。下面看一个例子：</p><div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;编辑器初始化后，编辑器区域会绑定 mouseup mousedown 事件，对range进行处理，如果range不存在，不处理&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> saveRangeFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> getRangeFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">,</span> <span class="token string">&#x27;saveRange&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span>saveRangeFn<span class="token punctuation">)</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">,</span> <span class="token string">&#x27;getRange&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span>getRangeFn<span class="token punctuation">)</span>

    <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">,</span> <span class="token string">&#x27;mousedown&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;MouseEvent&#x27;</span><span class="token punctuation">)</span>
    <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">,</span> <span class="token string">&#x27;mouseup&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;MouseEvent&#x27;</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>saveRangeFn<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>在上面的例子，我们测试的是当点击编辑区会保存当前 <code class="language-text">range</code> 的情况，如果当前的 <code class="language-text">range</code> 对象为 <code class="language-text">null</code>，则不执行 <code class="language-text">saveRange</code> 方法。我们通过 <code class="language-text">spyOn</code> 分别创建了模拟函数 <code class="language-text">saveRangeFn</code> 和 存根函数 <code class="language-text">getRangeFn</code>，使得测试变得简单。当然除了用在选区对象 <code class="language-text">selection</code> 对象，在其它一些类似的场景我也经常通过该 <code class="language-text">API</code> 进行对象方法的模拟，给我的体验就是非常简单好用。</p><p><code class="language-text">spyOn</code> 一般是用来劫持对象的方法，当然，在 <code class="language-text">Jest 22.1.0</code> 以后，你也可以用方法劫持对象属性的 <code class="language-text">getter</code>，但是这个 <code class="language-text">getter</code>必须是你自己在该对象上自定义的，而对象默认的 <code class="language-text">getter</code> 你是不能劫持的，简单来说，它还是不适合用来模拟对象的属性。所以在模拟对象属性的时候，我一般使用 <code class="language-text">Object.defineProperty</code>。这个 <code class="language-text">API</code> 相信大家都不陌生，只要对 <code class="language-text">Vue2.0</code> 响应式原理有过了解的话。它一般用来劫持对象的属性的 <code class="language-text">getter</code> 和 <code class="language-text">setter</code>，在一些测试场景下，我经常会用到。下面看一个例子：</p><div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> imgUrl <span class="token operator">=</span> <span class="token string">&#x27;http://www.wangeditor.com/imgs/logo.jpeg&#x27;</span>
<span class="token keyword">const</span> errorUrl <span class="token operator">=</span> <span class="token string">&#x27;error.jpeg&#x27;</span>

 Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span><span class="token class-name">Image</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&#x27;src&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// Define the property setter</span>
        <span class="token function">set</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">===</span> errorUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Call with setTimeout to simulate async loading</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;mocked error&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">===</span> imgUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
 
 <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;调用 insertImg 可以网编辑器里插入图片，插入图片加载失败可以通过customAlert配置错误提示&#x27;</span><span class="token punctuation">,</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> alertFn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> uploadImg <span class="token operator">=</span> <span class="token function">createUploadImgInstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span> customAlert<span class="token operator">:</span> alertFn <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">mockSupportCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        uploadImg<span class="token punctuation">.</span><span class="token function">insertImg</span><span class="token punctuation">(</span>errorUrl<span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">expect</span><span class="token punctuation">(</span>alertFn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span>
                <span class="token string">&#x27;插入图片错误&#x27;</span><span class="token punctuation">,</span>
                <span class="token string">&#x27;error&#x27;</span><span class="token punctuation">,</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wangEditor: 插入图片错误，图片链接 &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errorUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;，下载链接失败</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span>
            <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><p>上面的例子比较有意思，因为在 <code class="language-text">Jest</code> 中，我们没法真正触发图片的 <code class="language-text">error</code> 和 <code class="language-text">load</code> 事件，所以我使用了 <code class="language-text">Object.defineProperty</code> 劫持了 <code class="language-text">Image</code> 对象的 <code class="language-text">src</code> 的 <code class="language-text">set</code> 方法 ，根据不同的 <code class="language-text">src</code> 值去主动触发图片的 <code class="language-text">error</code> 或者 <code class="language-text">load</code> 事件，这样使得了 <code class="language-text">error</code> 和 <code class="language-text">load</code> 可以触发，从而使得我们测试能够成功。</p><p>通过上述的一系列例子，我也得出一个结论：在单元测试中，就基本没有什么是不能模拟的，只要你能充分理解和使用各种模拟技术，基本就能解决90%以上的测试问题。</p><h2 id="总结" style="position:relative"><a href="#%E6%80%BB%E7%BB%93" aria-label="总结 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2><p>经过一段时间的单元测试优化，我们的测试覆盖率，从 <strong>62%</strong> 提升到了 <strong>82%</strong>。我在团队内进行了线上的单元测试实践分享，大家也对单元测试有了新的理解和认识，对代码的单元测试也认真了起来，这也是我想看到的结果。一个项目的质量如何，稳不稳定，我觉得有一个比较重要的评判标准就是测试的覆盖率，没人愿意用一个没有测试的开源项目。</p><p>本文从模拟 <code class="language-text">document.execCommand</code>、模拟 <code class="language-text">XHR</code>、模拟用户交互、<code class="language-text">jest.spyOn</code> 和 <code class="language-text">Object.defineProperty</code> API 的使用的等方面介绍了模拟技术在 <code class="language-text">wangEditor</code> 中的实践，目前来看，还是取得了不错的效果。当然，有些实践我也不好说一定是最佳实践，但是它确实解决了我们目前测试覆盖率低的困境。</p><p>展望未来，我们可以做的更好是，更好地将单元测试与 <code class="language-text">E2E</code> 测试结合，相辅相成，组成 <code class="language-text">wangEditor</code> 的质量保护网。部分测试还有很多可以优化的空间，除了前期的一些功能模块测试覆盖率不够理想外，一些用例也不太符合优秀单元测试的标准。这些，我们都会在未来的重构中，慢慢进行优化。</p></div></section><footer class="Article__ArticleFooter-sc-1ux1py6-1 gtmBNT"><div class="Bio__BioWrapper-jo9hw1-0 dzXCsB"><figure class="author-image"><div alt="echoLC" style="background-image:url(&quot;/static/7293961783dbf36e4a6360fd98eff6dc/2244e/avatar.jpg&quot;)" class="img"></div></figure><section><h4>About the author</h4><p class="Commons__Text-sc-1olsuhn-1 Bio__BioText-jo9hw1-1 hXfboN bvupla">来自欢聚集团的前端开发开发工程师，现居广州。</p></section></div></footer></article></main><aside class="PrevNextPost__PreviewContainer-sc-123t7d4-0 bPNZMx"><article class="PrevNextPost__Preview-sc-123t7d4-1 egyLTL"><a aria-label="View ui-draw图片制作可视化方案设计总结 article" href="/ui-draw design"><div style="background-image:url(&quot;/static/1a66d47b0d7b28de3bfc22393a2ca946/cover3.jpg&quot;)" class="PrevNextPost__PreviewCover-sc-123t7d4-2 cyZgCh"></div><div class="PrevNextPost__PreviewContent-sc-123t7d4-3 eZfqaY"><header><h2>ui-draw图片制作可视化方案设计总结</h2></header><section><p></p></section><footer><span class="Commons__ReadingTimeContainer-sc-1olsuhn-3 jcGTcy"> min read</span><span class="Commons__Bull-sc-1olsuhn-2 hwmpTs"></span><div class="TagList__ListContainer-sc-1uer3n1-0 jjFmyv"><span to="/tags/react component" class="TagList__TagListItem-sc-1uer3n1-2 itnVfJ">react component</span>, <span to="/tags/图片制作可视化" class="TagList__TagListItem-sc-1uer3n1-2 itnVfJ">图片制作可视化</span></div></footer></div></a></article></aside></div><footer class="Footer__FooterWrapper-havaaf-0 cWabTu"><nav><div class="footer-col"><h3 class="footer-title">echoLC<!-- --> © <!-- -->2021</h3><p class="footer-item-text">使用 <!-- --> <a class="footer-link" href="https://www.gatsbyjs.org">Gatsby</a>构建 .</p><p class="footer-item-text">主题使用 <!-- --> <a class="footer-link" href="https://github.com/maxpou/gatsby-starter-morning-dew">gatsby-starter-morning-dew</a>.</p><p class="footer-item-text">部署在 <!-- --> <span class="footer-heart" role="img" aria-label="Love">❤</span> <a class="footer-link" href="https://github.com">GitHub</a>.</p></div><div class="footer-col"><h3 class="footer-title">探索</h3><div class="footer-column-items"><span class="footer-item"><a class="footer-link" href="/">博客</a></span><span class="footer-item"><a class="footer-link" href="/about">关于</a></span></div></div><div class="footer-col"><h3 class="footer-title">关注我</h3><div class="footer-column-items"><span class="footer-item"><a class="footer-link" href="https://github.com/echoLC">GitHub</a></span><span class="footer-item"><a class="footer-link" href="https://echolc.github.io/">网站</a></span><span class="footer-item"><a class="footer-link" href="https://juejin.im/user/3702810893618253">掘金</a></span></div></div></nav></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-67868977-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/jest-mock-practice-inn-wangEditor";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-98d0d39eedcf3238f399.js"],"app":["/app-35c7a169ecc7765edc62.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-b0556ce5127c1a3e2490.js"],"component---src-pages-404-js":["/component---src-pages-404-js-6ef0f25d9cf6d3fc2e48.js"],"component---src-templates-blog-list-template-js":["/component---src-templates-blog-list-template-js-40b5f02d158ddc2095ea.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-7c929e5f88b2d26f9440.js"],"component---src-templates-page-js":["/component---src-templates-page-js-a8ba58efc7b2a912209f.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-5ee4847005e7101dc9a9.js"]};/*]]>*/</script><script src="/polyfill-98d0d39eedcf3238f399.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-7c929e5f88b2d26f9440.js" async=""></script><script src="/3a2f1ab89072400eb78a258db61265f1964eff8a-17ff65e584d80acaf7aa.js" async=""></script><script src="/styles-e9d24b1846c7d6eb9685.js" async=""></script><script src="/app-35c7a169ecc7765edc62.js" async=""></script><script src="/framework-445649399d1c721f1f74.js" async=""></script><script src="/webpack-runtime-c61a43b1af9572f2b9fb.js" async=""></script></body></html>